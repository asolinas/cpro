<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<title>Canzoniere</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  font-family: sans-serif;
  padding: 20px;
  background: #ffffff;
}

h1 {
  margin-bottom: 5px;
}

#search {
  padding: 10px;
  width: 320px;
  font-size: 16px;
  margin: 20px 0;
  border-radius: 8px;
  border: 1px solid #bbb;
}

#uploadForm {
  margin-top: 10px;
  margin-bottom: 30px;
}

button {
  padding: 8px 14px;
  background: #444;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

.song-card {
  padding: 14px;
  border: 1px solid #ddd;
  margin-bottom: 10px;
  border-radius: 10px;
  background: #fafafa;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.song-info {
  display: flex;
  flex-direction: column;
}

.song-title {
  font-size: 20px;
  font-weight: bold;
}

.song-subtitle {
  font-size: 14px;
  color: #666;
}

.actions {
  display: flex;
  gap: 10px;
}

.actions img {
  width: 28px;
  cursor: pointer;
}

</style>
</head>

<body>

<h1>Canzoniere</h1>

<h2>Carica nuovo file</h2>
<form id="uploadForm" onsubmit="uploadFile(event)">
  <input type="file" id="fileInput" required />
  <button type="submit">Carica</button>
</form>

<input type="text" id="search" placeholder="Cerca per titolo, autore o nome fileâ€¦" oninput="renderList()" />

<div id="list"></div>

<script>
// =======================================
// SUPABASE CONFIG
// =======================================
const SUPABASE_URL = "https://xqrhpgrznrmewtgxxngu.supabase.co";
const SUPABASE_ANON_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhxcmhwZ3J6bnJtZXd0Z3h4bmd1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMjcyNzUsImV4cCI6MjA4MDYwMzI3NX0.jQNuHTWj4bu4Ji_2ALFzB9Tulf_tM9A1tXBEUVzuaKc";

const BUCKET = "files";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let songs = [];


// =======================================
// REMOVE TAGS {font}, {color} etc.
// =======================================
function cleanTags(text) {
  return text.replace(/\{[^}]+\}/g, "");
}


// =======================================
// PARSE TITLE + SUBTITLE (Title:, Subtitle:, {st:})
// =======================================
function parseMetadata(text) {
  let title = "", subtitle = "";

  const patterns = [
    { regex: /^Title:\s*(.*)$/mi, target: "title" },
    { regex: /^\{title:\s*(.*?)\}$/mi, target: "title" },

    { regex: /^Subtitle:\s*(.*)$/mi, target: "subtitle" },
    { regex: /^\{subtitle:\s*(.*?)\}$/mi, target: "subtitle" },
    { regex: /^\{st:\s*(.*?)\}$/mi, target: "subtitle" }
  ];

  for (let p of patterns) {
    const m = text.match(p.regex);
    if (m) {
      if (p.target === "title") title = m[1].trim();
      if (p.target === "subtitle") subtitle = m[1].trim();
    }
  }

  return { title, subtitle };
}


// =======================================
// UPLOAD FILE
// =======================================
async function uploadFile(evt) {
  evt.preventDefault();

  const fileEl = document.getElementById("fileInput");
  const file = fileEl.files[0];
  if (!file) return;

  const { error } = await supabaseClient
    .storage
    .from(BUCKET)
    .upload(file.name, file, { upsert: true });

  if (error) {
    alert("Errore caricamento: " + error.message);
    return;
  }

  fileEl.value = "";
  await loadList();
}


// =======================================
// DELETE FILE
// =======================================
async function deleteFile(name) {
  if (!confirm(`Vuoi davvero eliminare "${name}"?`)) return;

  const { error } = await supabaseClient.storage.from(BUCKET).remove([name]);
  if (error) return alert("Errore eliminazione: " + error.message);

  songs = songs.filter(s => s.filename !== name);
  renderList();
}


// =======================================
// LOAD LIST OF FILES
// =======================================
async function loadList() {
  const { data, error } = await supabaseClient.storage.from(BUCKET).list("", { limit: 500 });

  if (error) {
    alert("Errore lista file: " + error.message);
    return;
  }

  songs = [];

  for (let f of data) {

    const { data: fileData, error: dErr } =
      await supabaseClient.storage.from(BUCKET).download(f.name);

    if (dErr) continue;

    const txt = cleanTags(await fileData.text());
    const meta = parseMetadata(txt);

    songs.push({
      filename: f.name,
      title: meta.title || f.name.replace(/\.[^.]+$/, ""),
      subtitle: meta.subtitle || ""
    });
  }

  // Oridna alfabeticamente per TITOLO
  songs.sort((a, b) => a.title.localeCompare(b.title));

  renderList();
}


// =======================================
// RENDER LIST + SEARCH
// =======================================
function renderList() {
  const q = document.getElementById("search").value.toLowerCase();
  const list = document.getElementById("list");
  list.innerHTML = "";

  songs
    .filter(s =>
      s.title.toLowerCase().includes(q) ||
      s.subtitle.toLowerCase().includes(q) ||
      s.filename.toLowerCase().includes(q)
    )
    .forEach(s => {
      const div = document.createElement("div");
      div.className = "song-card";

      div.innerHTML = `
        <div class="song-info">
          <div class="song-title">${s.title}</div>
          <div class="song-subtitle">${s.subtitle}</div>
        </div>

        <div class="actions">
          <a href="viewer.html?file=${encodeURIComponent(s.filename)}">
            <img src="assets/icons/open.png" title="Apri">
          </a>
          <img src="assets/icons/delete.png" onclick="deleteFile('${s.filename}')" title="Elimina">
        </div>
      `;

      list.appendChild(div);
    });
}


// =======================================
// INIT
// =======================================
loadList();
</script>

</body>
</html>



