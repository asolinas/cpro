<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<title>Canzoniere</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="styles.css" />

<style>
body {
  font-family: sans-serif;
  padding: 20px;
}

#search {
  padding: 10px;
  width: 300px;
  font-size: 16px;
  margin-bottom: 20px;
}

.song-card {
  padding: 12px;
  border: 1px solid #ccc;
  margin-bottom: 10px;
  border-radius: 8px;
  background: #fafafa;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.song-info {
  display: flex;
  flex-direction: column;
}

.song-title {
  font-size: 20px;
  font-weight: bold;
}

.song-subtitle {
  font-size: 14px;
  color: #555;
}

.actions {
  display: flex;
  gap: 10px;
}

.actions img {
  width: 28px;
  cursor: pointer;
}
</style>

</head>
<body>

<h1>Canzoniere</h1>

<input type="text" id="search" placeholder="Cerca per titolo, autore o nome file…" oninput="renderList()" />

<div id="list"></div>

<script>
// ======================
// SUPABASE CONFIG
// ======================
const SUPABASE_URL = "https://xqrhpgrznrmewtgxxngu.supabase.co";
const SUPABASE_ANON_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhxcmhwZ3J6bnJtZXd0Z3h4bmd1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMjcyNzUsImV4cCI6MjA4MDYwMzI3NX0.jQNuHTWj4bu4Ji_2ALFzB9Tulf_tM9A1tXBEUVzuaKc";

const BUCKET = "files";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let songs = [];


// ======================
// CLEAN TAGS
// ======================
function cleanTags(text) {
    return text.replace(/\{(font|color|chordChartSize|playtime|chorusindent|chordspace|linespace|transpositionLevel|EditorBack|Background|Highlight)[^}]*\}/gi, "");
}


// ======================
// PARSE METADATA
// ======================
function parseMetadata(text) {
    let title = "";
    let subtitle = "";

    const patterns = [
        { regex: /^Title:\s*(.*)$/mi, target: "title" },
        { regex: /^\{title:\s*(.*?)\}$/mi, target: "title" },
        { regex: /^Subtitle:\s*(.*)$/mi, target: "subtitle" },
        { regex: /^\{subtitle:\s*(.*?)\}$/mi, target: "subtitle" },
        { regex: /^\{st:\s*(.*?)\}$/mi, target: "subtitle" }
    ];

    for (let p of patterns) {
        const match = text.match(p.regex);
        if (match) {
            if (p.target === "title") title = match[1].trim();
            if (p.target === "subtitle") subtitle = match[1].trim();
        }
    }

    return { title, subtitle };
}


// ======================
// DELETE FILE
// ======================
async function deleteFile(name) {
    if (!confirm(`Vuoi davvero eliminare "${name}"?`)) return;

    const { error } = await supabaseClient.storage.from(BUCKET).remove([name]);

    if (error) return alert("Errore eliminazione: " + error.message);

    songs = songs.filter(s => s.filename !== name);
    renderList();
}


// ======================
// LOAD LIST
// ======================
async function loadList() {
    const { data, error } = await supabaseClient.storage.from(BUCKET).list("", { limit: 200 });

    if (error) return alert("Errore: " + error.message);

    // Per ogni file scarico solo i metadata
    songs = [];

    for (let f of data) {
        const { data: file, error: err2 } = await supabaseClient.storage.from(BUCKET).download(f.name);
        if (err2) continue;

        const txt = cleanTags(await file.text());
        const meta = parseMetadata(txt);

        songs.push({
            filename: f.name,
            title: meta.title || f.name.replace(".cho", ""),
            subtitle: meta.subtitle || ""
        });
    }

    // ORDINAMENTO (scelto da te) → per TITOLO
    songs.sort((a, b) => a.title.localeCompare(b.title));

    renderList();
}


// ======================
// RENDER LIST
// ======================
function renderList() {
    const q = document.getElementById("search").value.toLowerCase();
    const list = document.getElementById("list");
    list.innerHTML = "";

    songs
        .filter(s =>
            s.title.toLowerCase().includes(q) ||
            s.subtitle.toLowerCase().includes(q) ||
            s.filename.toLowerCase().includes(q)
        )
        .forEach(s => {

            const div = document.createElement("div");
            div.className = "song-card";

            div.innerHTML = `
                <div class="song-info">
                    <div class="song-title">${s.title}</div>
                    <div class="song-subtitle">${s.subtitle}</div>
                </div>

                <div class="actions">
                    <a href="viewer.html?file=${encodeURIComponent(s.filename)}">
                        <img src="assets/icons/open.png" title="Apri">
                    </a>
                    <img src="assets/icons/delete.png" onclick="deleteFile('${s.filename}')" title="Elimina">
                </div>
            `;

            list.appendChild(div);
        });
}


// START
loadList();
</script>

</body>
</html>

