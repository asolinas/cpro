<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<title>Canzoniere</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  font-family: sans-serif;
  padding: 20px;
  background: #ffffff;
}

#search {
  padding: 10px;
  width: 320px;
  font-size: 16px;
  margin: 20px 0;
  border-radius: 8px;
  border: 1px solid #bbb;
}

.song-card {
  padding: 14px;
  border: 1px solid #ddd;
  margin-bottom: 10px;
  border-radius: 10px;
  background: #fafafa;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.song-title {
  font-size: 20px;
  font-weight: bold;
}

.song-subtitle {
  font-size: 14px;
  color: #666;
}

.actions img {
  width: 28px;
  cursor: pointer;
}
</style>
</head>

<body>

<h1>Canzoniere</h1>

<h2>Carica nuovo file</h2>
<form id="uploadForm" onsubmit="uploadFile(event)">
  <input type="file" id="fileInput" required />
  <button type="submit">Carica</button>
</form>

<input type="text" id="search" placeholder="Cerca per titolo, autore o nome fileâ€¦" oninput="renderList()" />

<div id="list"></div>

<script>
// =======================================
// SUPABASE CONFIG
// =======================================
const SUPABASE_URL = "https://xqrhpgrznrmewtgxxngu.supabase.co";
const SUPABASE_ANON_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhxcmhwZ3J6bnJtZXd0Z3h4bmd1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMjcyNzUsImV4cCI6MjA4MDYwMzI3NX0.jQNuHTWj4bu4Ji_2ALFzB9Tulf_tM9A1tXBEUVzuaKc";

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const BUCKET = "files";

let songs = [];

// =======================================
// REMOVE TAGS BUT KEEP METADATA
// =======================================
function cleanTags(text) {
  return text.replace(/\{(?!title:|subtitle:|st:)[^}]+\}/gi, "");
}

// =======================================
// METADATA PARSER FIX V4
// =======================================
function parseMetadata(text) {
  let title = "", subtitle = "";

  const lines = text.split("\n");

  for (let raw of lines) {
    const line = raw.trim().replace(/^\uFEFF/, "").replace(/\u200B/g, "");

    let m;

    m = line.match(/^\{?\s*(title|t)\s*:\s*(.*?)\s*\}?$/i);
    if (m) { title = m[2].trim(); continue; }

    m = line.match(/^\{?\s*(subtitle|sub|st)\s*:\s*(.*?)\s*\}?$/i);
    if (m) { subtitle = m[2].trim(); continue; }

    m = line.match(/^[\uFEFF\s]*title\s*:\s*(.*)$/i);
    if (m) { title = m[1].trim(); continue; }

    m = line.match(/^[\uFEFF\s]*subtitle\s*:\s*(.*)$/i);
    if (m) { subtitle = m[1].trim(); continue; }
  }

  return { title, subtitle };
}

// =======================================
// UPLOAD
// =======================================
async function uploadFile(evt) {
  evt.preventDefault();
  const file = document.getElementById("fileInput").files[0];
  if (!file) return;

  const { error } = await supabaseClient.storage.from(BUCKET).upload(file.name, file, { upsert: true });
  if (error) return alert("Errore caricamento: " + error.message);

  loadList();
}

// =======================================
// DELETE
// =======================================
async function deleteFile(name) {
  if (!confirm(`Eliminare "${name}"?`)) return;
  const { error } = await supabaseClient.storage.from(BUCKET).remove([name]);
  if (error) return alert("Errore eliminazione");

  songs = songs.filter(s => s.filename !== name);
  renderList();
}

// =======================================
// LOAD FILES & PARSE METADATA
// =======================================
async function loadList() {
  const { data, error } = await supabaseClient.storage.from(BUCKET).list("", { limit: 500 });
  if (error) return alert("Errore lista");

  songs = [];

  for (let f of data) {
    const fileObj = await supabaseClient.storage.from(BUCKET).download(f.name);
    if (fileObj.error) continue;

    let raw = await fileObj.data.text();
    raw = raw.replace(/^\uFEFF/, "").replace(/\u200B/g, "");

    const metadata = parseMetadata(raw);
    const cleaned = cleanTags(raw);

    songs.push({
      filename: f.name,
      title: metadata.title || f.name.replace(/\.[^.]+$/, ""),
      subtitle: metadata.subtitle || ""
    });
  }

  songs.sort((a, b) => a.title.localeCompare(b.title));
  renderList();
}

// =======================================
// RENDER LIST
// =======================================
function renderList() {
  const q = document.getElementById("search").value.toLowerCase();
  const list = document.getElementById("list");
  list.innerHTML = "";

  songs
    .filter(s =>
      s.title.toLowerCase().includes(q) ||
      s.subtitle.toLowerCase().includes(q) ||
      s.filename.toLowerCase().includes(q)
    )
    .forEach(s => {
      const div = document.createElement("div");
      div.className = "song-card";
      div.innerHTML = `
        <div>
          <div class="song-title">${s.title}</div>
          <div class="song-subtitle">${s.subtitle}</div>
        </div>
        <div class="actions">
          <a href="viewer.html?file=${encodeURIComponent(s.filename)}">
            <img src="assets/icons/open.png">
          </a>
          <img src="assets/icons/delete.png" onclick="deleteFile('${s.filename}')">
        </div>
      `;
      list.appendChild(div);
    });
}

loadList();
</script>

</body>
</html>



