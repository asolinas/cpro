<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<title>Viewer Canzoniere</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="styles.css" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
#content { padding: 20px; }
</style>
</head>

<body>

<div id="toolbar">
  <button class="toolbar-btn" onclick="transpose(-1)" title="Trasponi -"><img src="assets/icons/transpose_minus.png" class="icon"></button>
  <button class="toolbar-btn" onclick="transpose(1)" title="Trasponi +"><img src="assets/icons/transpose_plus.png" class="icon"></button>
  <button class="toolbar-btn" onclick="resize(-1)" title="Font -"><img src="assets/icons/font_minus.png" class="icon"></button>
  <button class="toolbar-btn" onclick="resize(1)" title="Font +"><img src="assets/icons/font_plus.png" class="icon"></button>
  <button class="toolbar-btn" onclick="toggleNotation()" title="EN ⇄ ITA"><img src="assets/icons/notation.png" class="icon"></button>
  <button class="toolbar-btn" onclick="exportPDF()" title="Esporta PDF"><img src="assets/icons/pdf.png" class="icon"></button>
</div>

<h1 id="title"></h1>
<h2 id="subtitle"></h2>

<div id="content"></div>

<script>
// ======================
// SUPABASE CONFIG
// ======================
const SUPABASE_URL = "https://xqrhpgrznrmewtgxxngu.supabase.co";
const SUPABASE_ANON_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhxcmhwZ3J6bnJtZXd0Z3h4bmd1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMjcyNzUsImV4cCI6MjA4MDYwMzI3NX0.jQNuHTWj4bu4Ji_2ALFzB9Tulf_tM9A1tXBEUVzuaKc";

const BUCKET = "files";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// filename
const filename = new URLSearchParams(location.search).get("file");
let originalText = "";
let notation = "EN";


// ======================
// CLEAN TAGS
// ======================
function cleanTags(text) {
    return text.replace(/\{(font|color|chordChartSize|playtime|chorusindent|chordspace|linespace|transpositionLevel|EditorBack|Background|Highlight)[^}]*\}/gi, "");
}


// ======================
// PARSE TITLE + SUBTITLE
// ======================
function parseMetadata(text) {
    let title = "";
    let subtitle = "";

    const patterns = [
        { regex: /^Title:\s*(.*)$/mi, target: "title" },
        { regex: /^\{title:\s*(.*?)\}$/mi, target: "title" },
        { regex: /^Subtitle:\s*(.*)$/mi, target: "subtitle" },
        { regex: /^\{subtitle:\s*(.*?)\}$/mi, target: "subtitle" },
        { regex: /^\{st:\s*(.*?)\}$/mi, target: "subtitle" }
    ];

    for (let p of patterns) {
        const match = text.match(p.regex);
        if (match) {
            if (p.target === "title") title = match[1].trim();
            if (p.target === "subtitle") subtitle = match[1].trim();
        }
    }

    document.getElementById("title").textContent = title;
    document.getElementById("subtitle").textContent = subtitle;

    return { title, subtitle };
}


// ======================
// NOTATION MAPS (MAIUSCOLO)
// ======================
const EN_TO_IT = {
    "C":"DO","C#":"DO#","D":"RE","D#":"RE#","E":"MI","F":"FA","F#":"FA#",
    "G":"SOL","G#":"SOL#","A":"LA","A#":"LA#","B":"SI"
};

const IT_TO_EN = {
    "DO":"C","DO#":"C#","RE":"D","RE#":"D#","MI":"E","FA":"F","FA#":"F#",
    "SOL":"G","SOL#":"G#","LA":"A","LA#":"A#","SI":"B"
};


// ======================
// LOAD SONG
// ======================
async function loadSong() {
    const { data, error } = await supabaseClient.storage.from(BUCKET).download(filename);

    if (error) return alert("Errore: " + error.message);

    const txt = await data.text();

    originalText = cleanTags(txt);
    renderSong(originalText);
}


// ======================
// RENDER SONG
// ======================
function renderSong(text) {
    parseMetadata(text);

    const lines = text.split("\n");
    const container = document.getElementById("content");
    container.innerHTML = "";

    for (let line of lines) {

        if (line.match(/^\{.*?\}$/)) continue; // ignora tag

        if (line.match(/^Title:/i) ||
            line.match(/^Subtitle:/i) ||
            line.match(/^\{title:/i) ||
            line.match(/^\{subtitle:/i) ||
            line.match(/^\{st:/i)) continue;

        const chords = [...line.matchAll(/\[([^\]]+)\]/g)];
        const textOnly = line.replace(/\[[^\]]+\]/g, "");

        const lineDiv = document.createElement("div");
        lineDiv.className = "song-line";

        if (chords.length > 0) {
            let chordLine = "";
            let pos = 0;
            line.replace(/\[([^\]]+)\]/g, (m, chord, offset) => {
                chordLine += " ".repeat(offset - pos) + chord;
                pos = offset;
            });

            const chordEl = document.createElement("div");
            chordEl.className = "chord-line";
            chordEl.textContent = chordLine;
            lineDiv.appendChild(chordEl);
        }

        const textEl = document.createElement("div");
        textEl.className = "text-line";
        textEl.textContent = textOnly;
        lineDiv.appendChild(textEl);

        container.appendChild(lineDiv);
    }
}


// ======================
// TRANSPOSE ACCUMULATO
// ======================
function transpose(semitones) {
    function shift(note) {
        const scale = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
        let root = note.match(/[A-G]#?/);
        if (!root) return note;

        let index = scale.indexOf(root[0]);
        if (index === -1) return note;

        let newIndex = (index + semitones + 12) % 12;
        return note.replace(root[0], scale[newIndex]);
    }

    const newText = originalText.replace(/\[([^\]]+)\]/g, (m, chord) =>
        "[" + chord.replace(/[A-G]#?/g, c => shift(c)) + "]"
    );

    originalText = newText;
    renderSong(newText);
}


// ======================
// TOGGLE EN ⇄ ITA
// ======================
function toggleNotation() {
    notation = (notation === "EN") ? "IT" : "EN";
    const map = (notation === "EN") ? IT_TO_EN : EN_TO_IT;

    const converted = originalText.replace(/\[([^\]]+)\]/g, (m, chord) =>
        "[" + chord.replace(/(DO#?|RE#?|MI|FA#?|SOL#?|LA#?|SI|C#?|D#?|F#?|G#?|A#?|[CDEFGAB])/g,
            c => map[c] || c
        ) + "]"
    );

    originalText = converted;
    renderSong(converted);
}


// ======================
// FONT RESIZE
// ======================
function resize(delta) {
    document.querySelectorAll(".text-line, .chord-line").forEach(el => {
        let size = parseFloat(window.getComputedStyle(el).fontSize);
        el.style.fontSize = (size + delta) + "px";
    });
}


// ======================
// EXPORT PDF
// ======================
async function exportPDF() {
    const { jsPDF } = window.jspdf;
    const canvas = await html2canvas(document.body, { scale: 2 });

    const img = canvas.toDataURL("image/png");
    const pdf = new jsPDF("p", "mm", "a4");
    const width = pdf.internal.pageSize.getWidth();
    const height = (canvas.height * width) / canvas.width;

    pdf.addImage(img, "PNG", 0, 0, width, height);
    pdf.save((document.getElementById("title").textContent || "Canzone") + ".pdf");
}


// START
loadSong();
</script>

</body>
</html>
