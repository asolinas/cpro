<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<title>Viewer Canzoniere</title>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- PDF generator -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body {
  font-family: sans-serif;
  margin: 0;
  padding: 0;
  background: #ffffff;
}

#toolbar {
  display: flex;
  gap: 12px;
  padding: 10px 15px;
  border-bottom: 1px solid #ddd;
  background: #fafafa;
  position: sticky;
  top: 0;
  z-index: 50;
}

.toolbar-btn img {
  width: 32px;
  cursor: pointer;
}

#content {
  padding: 20px;
}

.song-line {
  margin-bottom: 14px;
  white-space: pre;
  font-family: monospace;
}

.chord-line {
  font-weight: bold;
  color: #333;
}

.text-line {
  margin-top: -4px;
}
</style>
</head>

<body>

<!-- ================ TOOLBAR ================ -->
<div id="toolbar">
  <button class="toolbar-btn" onclick="transpose(-1)"><img src="assets/icons/transpose_minus.png"></button>
  <button class="toolbar-btn" onclick="transpose(1)"><img src="assets/icons/transpose_plus.png"></button>
  <button class="toolbar-btn" onclick="resize(-1)"><img src="assets/icons/font_minus.png"></button>
  <button class="toolbar-btn" onclick="resize(1)"><img src="assets/icons/font_plus.png"></button>
  <button class="toolbar-btn" onclick="toggleNotation()"><img src="assets/icons/notation.png"></button>
  <button class="toolbar-btn" onclick="exportPDF()"><img src="assets/icons/pdf.png"></button>
</div>

<h1 id="title" style="padding-left:20px;"></h1>
<h2 id="subtitle" style="padding-left:20px; color:#666;"></h2>

<div id="content"></div>

<script>
// =======================================
// SUPABASE CONFIG
// =======================================
const SUPABASE_URL = "https://xqrhpgrznrmewtgxxngu.supabase.co";
const SUPABASE_ANON_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhxcmhwZ3J6bnJtZXd0Z3h4bmd1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMjcyNzUsImV4cCI6MjA4MDYwMzI3NX0.jQNuHTWj4bu4Ji_2ALFzB9Tulf_tM9A1tXBEUVzuaKc";

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const BUCKET = "files";

const filename = new URLSearchParams(location.search).get("file");

let originalText = "";
let notation = "EN"; // EN or IT

// =======================================
// SCALE & MAPS
// =======================================
const NOTES_EN = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
const NOTES_IT = ["DO","DO#","RE","RE#","MI","FA","FA#","SOL","SOL#","LA","LA#","SI"];

const MAP_EN_IT = Object.fromEntries(NOTES_EN.map((n,i)=>[n, NOTES_IT[i]]));
const MAP_IT_EN = Object.fromEntries(NOTES_IT.map((n,i)=>[n, NOTES_EN[i]]));


// =======================================
// CLEAN TAGS
// =======================================
function cleanTags(text) {
  return text.replace(/\{[^}]+\}/g, "");
}


// =======================================
// PARSE METADATA
// =======================================
function parseMetadata(text) {
  let title = "", subtitle = "";

  const patterns = [
    {regex: /^Title:\s*(.*)$/mi, target:"title"},
    {regex: /^\{title:\s*(.*?)\}$/mi, target:"title"},

    {regex: /^Subtitle:\s*(.*)$/mi, target:"subtitle"},
    {regex: /^\{subtitle:\s*(.*?)\}$/mi, target:"subtitle"},
    {regex: /^\{st:\s*(.*?)\}$/mi, target:"subtitle"},
  ];

  for (let p of patterns) {
    const m = text.match(p.regex);
    if (m) {
      if (p.target==="title") title = m[1].trim();
      if (p.target==="subtitle") subtitle = m[1].trim();
    }
  }

  document.getElementById("title").textContent = title;
  document.getElementById("subtitle").textContent = subtitle;
}


// =======================================
// CHORD PARSER
// =======================================
function parseChord(chord) {
  const slash = chord.split("/");
  const base = slash[0];
  const bass = slash[1];

  const rootMatch = base.match(/^(DO#?|RE#?|MI|FA#?|SOL#?|LA#?|SI|C#?|D#?|F#?|G#?|A#?|[CDEFGAB])/i);
  if (!rootMatch) return {root:null, suffix:base, bass};

  const root = rootMatch[0].toUpperCase();
  const suffix = base.slice(root.length);

  return {root, suffix, bass};
}


// =======================================
// TRANSPOSE LOGIC
// =======================================
function transposeChord(chord, steps, useItalian) {
  const {root, suffix, bass} = parseChord(chord);
  if (!root) return chord;

  const EN = NOTES_EN;

  const rootEN = useItalian ? MAP_IT_EN[root] : root;
  const idx = EN.indexOf(rootEN);
  if (idx < 0) return chord;

  const newRootEN = EN[(idx + steps + 12) % 12];
  const newRoot = useItalian ? MAP_EN_IT[newRootEN] : newRootEN;

  let newBass = bass;
  if (bass) newBass = transposeChord(bass, steps, useItalian);

  return newBass ? newRoot + suffix + "/" + newBass : newRoot + suffix;
}


function transpose(steps) {
  const useItalian = notation === "IT";

  originalText = originalText.replace(/\[([^\]]+)\]/g, (_, chord) => {
    return "[" + transposeChord(chord, steps, useItalian) + "]";
  });

  renderSong(originalText);
}


// =======================================
// NOTATION TOGGLE
// =======================================
function toggleNotation() {
  const toIT = (notation === "EN");
  notation = toIT ? "IT" : "EN";

  originalText = originalText.replace(/\[([^\]]+)\]/g, (_, chord) => {
    const {root, suffix, bass} = parseChord(chord);
    if (!root) return "["+chord+"]";

    const newRoot = toIT ? MAP_EN_IT[root] : MAP_IT_EN[root];
    let newBass = bass;
    if (bass) newBass = toIT ? MAP_EN_IT[bass] : MAP_IT_EN[bass];

    return "[" + (newBass ? newRoot + suffix + "/" + newBass : newRoot + suffix) + "]";
  });

  renderSong(originalText);
}


// =======================================
// LOAD SONG
// =======================================
async function loadSong() {
  const {data, error} = await supabaseClient.storage.from(BUCKET).download(filename);
  if (error) return alert("Errore caricamento file: "+error.message);

  const txt = await data.text();
  originalText = cleanTags(txt);

  renderSong(originalText);
}


// =======================================
// RENDER SONG (with chords above)
// =======================================
function renderSong(text) {

  parseMetadata(text);

  const container = document.getElementById("content");
  container.innerHTML = "";

  const lines = text.split("\n");

  for (let line of lines) {

    if (line.match(/^\{.*?\}$/)) continue;
    if (line.match(/^Title:/i) || line.match(/^Subtitle:/i)) continue;

    const chords = [...line.matchAll(/\[([^\]]+)\]/g)];
    const textOnly = line.replace(/\[[^\]]+\]/g, "");

    const div = document.createElement("div");
    div.className = "song-line";

    if (chords.length > 0) {
      let chordLine = "";
      let pos = 0;

      line.replace(/\[([^\]]+)\]/g, (m, chord, offset) => {
        chordLine += " ".repeat(offset - pos) + chord;
        pos = offset;
      });

      const chordEl = document.createElement("div");
      chordEl.className = "chord-line";
      chordEl.textContent = chordLine;
      div.appendChild(chordEl);
    }

    const textEl = document.createElement("div");
    textEl.className = "text-line";
    textEl.textContent = textOnly;
    div.appendChild(textEl);

    container.appendChild(div);
  }
}


// =======================================
// FONT RESIZE
// =======================================
function resize(n) {
  document.querySelectorAll(".text-line, .chord-line").forEach(el => {
    const size = parseFloat(getComputedStyle(el).fontSize);
    el.style.fontSize = (size + n) + "px";
  });
}


// =======================================
// PDF EXPORT (TRUE VIEW MODE)
// =======================================
async function exportPDF() {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("p", "mm", "a4");

  let y = 20;
  const pageHeight = pdf.internal.pageSize.getHeight();

  pdf.setFontSize(20);
  pdf.text(document.getElementById("title").textContent, 10, y);
  y += 10;

  pdf.setFontSize(14);
  pdf.text(document.getElementById("subtitle").textContent, 10, y);
  y += 12;

  const lines = document.querySelectorAll(".song-line");

  for (const line of lines) {

    const chordEl = line.querySelector(".chord-line");
    const textEl  = line.querySelector(".text-line");

    if (chordEl) {
      const size = parseFloat(getComputedStyle(chordEl).fontSize);
      pdf.setFontSize(size * 0.75);
      pdf.text(chordEl.textContent, 10, y);
      y += size * 0.45;
    }

    if (textEl) {
      const size = parseFloat(getComputedStyle(textEl).fontSize);
      pdf.setFontSize(size * 0.75);
      pdf.text(textEl.textContent, 10, y);
      y += size * 0.65;
    }

    if (y > pageHeight - 20) {
      pdf.addPage();
      y = 20;
    }
  }

  pdf.save((document.getElementById("title").textContent || "Canzone") + ".pdf");
}


// =======================================
// INIT
// =======================================
loadSong();
</script>

</body>
</html>


