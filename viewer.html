<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<title>ChoPro Viewer</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  background: #fff;
  font-family: "Segoe UI", sans-serif;
  margin: 0;
  padding: 0;
}

#toolbar {
  display: flex;
  gap: 12px;
  padding: 12px;
  background: #f7f7f7;
  border-bottom: 1px solid #ddd;
  position: sticky;
  top: 0;
}

button {
  padding: 6px 12px;
  border-radius: 6px;
  border: 1px solid #ccc;
  background: #fff;
  cursor: pointer;
  font-size: 14px;
}

button:hover {
  background: #e9e9e9;
}

#title {
  font-size: 36px;
  font-weight: bold;
  text-align: center;
  margin-top: 20px;
}

#subtitle {
  font-size: 22px;
  color: #666;
  text-align: center;
  margin-bottom: 20px;
}

.song-line {
  margin-bottom: 18px;
}

.chord-line {
  color: #0D47A1;
  font-weight: bold;
  white-space: pre;
}

.text-line {
  white-space: pre;
  font-size: 20px;
}
</style>
</head>

<body>

<div id="toolbar">
  <button onclick="transpose(-1)">Trasponi -</button>
  <button onclick="transpose(1)">Trasponi +</button>

  <button onclick="resize(-1)">Font -</button>
  <button onclick="resize(1)">Font +</button>
</div>

<div id="title"></div>
<div id="subtitle"></div>

<div id="content"></div>

<script>
const SUPABASE_URL = "https://xqrhpgrznrmewtgxxngu.supabase.co";
const SUPABASE_ANON_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhxcmhwZ3J6bnJtZXd0Z3h4bmd1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMjcyNzUsImV4cCI6MjA4MDYwMzI3NX0.jQNuHTWj4bu4Ji_2ALFzB9Tulf_tM9A1tXBEUVzuaKc";
const BUCKET = "files";

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const params = new URLSearchParams(location.search);
const filename = params.get("file");

let originalText = "";

async function loadSong() {
  const { data, error } = await supabaseClient.storage.from(BUCKET).download(filename);
  if (error) return alert("Errore nel caricamento: " + error.message);

  originalText = await data.text();
  renderSong(originalText);
}

function parseMetadata(text) {
  let title = "";
  let subtitle = "";

  const m1 = text.match(/Title:\s*(.*)/i);
  if (m1) title = m1[1].trim();

  const m2 = text.match(/Subtitle:\s*(.*)/i);
  if (m2) subtitle = m2[1].trim();

  document.getElementById("title").textContent = title || "";
  document.getElementById("subtitle").textContent = subtitle || "";
}

function renderSong(txt) {
  parseMetadata(txt);

  const lines = txt.split("\n");
  const container = document.getElementById("content");
  container.innerHTML = "";

  for (let line of lines) {
    if (line.startsWith("Title:") || line.startsWith("Subtitle:")) continue;

    const chords = [...line.matchAll(/\[([^\]]+)\]/g)];
    const textOnly = line.replace(/\[[^\]]+\]/g, "");

    const lineDiv = document.createElement("div");
    lineDiv.className = "song-line";

    if (chords.length > 0) {
      let chordLine = "";
      let pos = 0;

      line.replace(/\[([^\]]+)\]/g, (m, chord, offset) => {
        chordLine += " ".repeat(offset - pos) + chord;
        pos = offset;
      });

      const chordEl = document.createElement("div");
      chordEl.className = "chord-line";
      chordEl.textContent = chordLine;
      lineDiv.appendChild(chordEl);
    }

    const textEl = document.createElement("div");
    textEl.className = "text-line";
    textEl.textContent = textOnly;
    lineDiv.appendChild(textEl);

    container.appendChild(lineDiv);
  }
}

function transpose(semitones) {
  function transposeChord(chord, semitones) {
    const scale = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
    const flatMap = { "Db":"C#", "Eb":"D#", "Gb":"F#", "Ab":"G#", "Bb":"A#" };

    chord = chord.replace(/([A-G][b#]?)/g, root => {
      let note = root.replace(/b/, "#");
      note = flatMap[note] || note;
      let idx = scale.indexOf(note);
      idx = (idx + semitones + 12) % 12;
      return scale[idx];
    });

    return chord;
  }

  originalText = originalText.replace(/\[([^\]]+)\]/g, (m, chord) =>
    "[" + transposeChord(chord, semitones) + "]"
  );
  renderSong(originalText);
}

function resize(delta) {
  const content = document.getElementById("content");
  const size = parseInt(window.getComputedStyle(content).fontSize);
  content.style.fontSize = (size + delta) + "px";
}

loadSong();
</script>

</body>
</html>
