<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<title>Viewer Canzoniere</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="styles.css" />

<style>
#content { padding: 20px; }
.song-line { margin-bottom: 10px; white-space: pre; font-family: monospace; }
.chord-line { font-weight: bold; color: #444; }
.text-line { margin-top: -4px; }
#toolbar { display: flex; gap: 10px; padding: 10px; border-bottom: 1px solid #ccc; }
.toolbar-btn img { width: 32px; cursor: pointer; }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body>

<!-- TOOLBAR -->
<div id="toolbar">
  <button class="toolbar-btn" onclick="transpose(-1)" title="Trasponi -">
    <img src="assets/icons/transpose_minus.png">
  </button>

  <button class="toolbar-btn" onclick="transpose(1)" title="Trasponi +">
    <img src="assets/icons/transpose_plus.png">
  </button>

  <button class="toolbar-btn" onclick="resize(-1)" title="Font -">
    <img src="assets/icons/font_minus.png">
  </button>

  <button class="toolbar-btn" onclick="resize(1)" title="Font +">
    <img src="assets/icons/font_plus.png">
  </button>

  <button class="toolbar-btn" onclick="toggleNotation()" title="EN ⇄ ITA">
    <img src="assets/icons/notation.png">
  </button>

  <button class="toolbar-btn" onclick="exportPDF()" title="Esporta PDF">
    <img src="assets/icons/pdf.png">
  </button>
</div>

<h1 id="title"></h1>
<h2 id="subtitle"></h2>

<div id="content"></div>

<script>
// =======================================
// SUPABASE CONFIG
// =======================================
const SUPABASE_URL = "https://xqrhpgrznrmewtgxxngu.supabase.co";
const SUPABASE_ANON_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhxcmhwZ3J6bnJtZXd0Z3h4bmd1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMjcyNzUsImV4cCI6MjA4MDYwMzI3NX0.jQNuHTWj4bu4Ji_2ALFzB9Tulf_tM9A1tXBEUVzuaKc";

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const BUCKET = "files";

const filename = new URLSearchParams(location.search).get("file");

let originalText = "";
let notation = "EN";


// =======================================
// CLEAN TAGS ChordPro (font, color, etc.)
// =======================================
function cleanTags(text) {
  return text.replace(/\{(font|color|chordChartSize|playtime|chorusindent|chordspace|linespace|transpositionLevel|EditorBack|Background|Highlight)[^}]*\}/gi, "");
}


// =======================================
// PARSE METADATA (title, subtitle)
// =======================================
function parseMetadata(text) {
  let title = "";
  let subtitle = "";

  const patterns = [
    { regex: /^Title:\s*(.*)$/mi, target: "title" },
    { regex: /^\{title:\s*(.*?)\}$/mi, target: "title" },
    { regex: /^Subtitle:\s*(.*)$/mi, target: "subtitle" },
    { regex: /^\{subtitle:\s*(.*?)\}$/mi, target: "subtitle" },
    { regex: /^\{st:\s*(.*?)\}$/mi, target: "subtitle" },
  ];

  for (const p of patterns) {
    const m = text.match(p.regex);
    if (m) {
      if (p.target === "title") title = m[1].trim();
      if (p.target === "subtitle") subtitle = m[1].trim();
    }
  }

  document.getElementById("title").textContent = title;
  document.getElementById("subtitle").textContent = subtitle;

  return { title, subtitle };
}


// =======================================
// LOAD SONG
// =======================================
async function loadSong() {
  const { data, error } = await supabaseClient.storage.from(BUCKET).download(filename);
  if (error) return alert("Errore caricamento file: " + error.message);

  const txt = await data.text();
  originalText = cleanTags(txt);

  renderSong(originalText);
}


// =======================================
// RENDER SONG (accordi sopra il testo)
// =======================================
function renderSong(text) {
  parseMetadata(text);

  const container = document.getElementById("content");
  container.innerHTML = "";

  const lines = text.split("\n");

  for (let line of lines) {

    // ignora tag residui
    if (line.match(/^\{.*?\}$/)) continue;

    // ignora meta
    if (line.match(/^Title:/i) ||
        line.match(/^Subtitle:/i) ||
        line.match(/^\{subtitle:/i) ||
        line.match(/^\{title:/i) ||
        line.match(/^\{st:/i)) continue;

    const chords = [...line.matchAll(/\[([^\]]+)\]/g)];
    const textOnly = line.replace(/\[[^\]]+\]/g, "");

    const div = document.createElement("div");
    div.className = "song-line";

    if (chords.length > 0) {
      let chordLine = "";
      let pos = 0;

      line.replace(/\[([^\]]+)\]/g, (m, chord, offset) => {
        chordLine += " ".repeat(offset - pos) + chord;
        pos = offset;
      });

      const chordEl = document.createElement("div");
      chordEl.className = "chord-line";
      chordEl.textContent = chordLine;
      div.appendChild(chordEl);
    }

    const textEl = document.createElement("div");
    textEl.className = "text-line";
    textEl.textContent = textOnly;
    div.appendChild(textEl);

    container.appendChild(div);
  }
}


// =======================================
// TRANSPOSE ACCUMULATO
// =======================================
function transpose(n) {

  function shift(note) {
    const scale = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
    let root = note.match(/[A-G]#?/);
    if (!root) return note;

    let idx = scale.indexOf(root[0]);
    if (idx < 0) return note;

    return note.replace(root[0], scale[(idx + n + 12) % 12]);
  }

  originalText = originalText.replace(/\[([^\]]+)\]/g,
    (m, chord) => "[" + chord.replace(/[A-G]#?/g, c => shift(c)) + "]"
  );

  renderSong(originalText);
}


// =======================================
// EN ⇄ ITA (MAIUSCOLO)
// =======================================
const EN_TO_IT = {
  "C":"DO","C#":"DO#","D":"RE","D#":"RE#","E":"MI","F":"FA","F#":"FA#",
  "G":"SOL","G#":"SOL#","A":"LA","A#":"LA#","B":"SI"
};
const IT_TO_EN = {
  "DO":"C","DO#":"C#","RE":"D","RE#":"D#","MI":"E","FA":"F","FA#":"F#",
  "SOL":"G","SOL#":"G#","LA":"A","LA#":"A#","SI":"B"
};

function toggleNotation() {
  notation = notation === "EN" ? "IT" : "EN";
  const map = notation === "EN" ? IT_TO_EN : EN_TO_IT;

  originalText = originalText.replace(/\[([^\]]+)\]/g, (m, chord) =>
    "[" + chord.replace(
      /(DO#?|RE#?|MI|FA#?|SOL#?|LA#?|SI|C#?|D#?|F#?|G#?|A#?|[CDEFGAB])/g,
      c => map[c] || c
    ) + "]"
  );

  renderSong(originalText);
}


// =======================================
// FONT RESIZE
// =======================================
function resize(n) {
  document.querySelectorAll(".text-line, .chord-line").forEach(el => {
    let size = parseFloat(getComputedStyle(el).fontSize);
    el.style.fontSize = (size + n) + "px";
  });
}


// =======================================
// EXPORT PDF **LEGGERO** (NO TOOLBAR)
// =======================================
async function exportPDF() {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("p", "mm", "a4");

  let y = 20;

  // Titolo
  pdf.setFontSize(20);
  pdf.text(document.getElementById("title").textContent || "", 10, y);
  y += 10;

  // Sottotitolo
  pdf.setFontSize(14);
  pdf.text(document.getElementById("subtitle").textContent || "", 10, y);
  y += 12;

  // Corpo testo
  pdf.setFontSize(11);
  const lines = originalText.split("\n");

  for (let line of lines) {

    if (line.match(/^\{.*?\}$/)) continue;
    if (line.match(/^Title:/i) || line.match(/^Subtitle:/i)) continue;

    if (line.includes("[")) {
      let chords = line.replace(/[^\]]+\]/g, match => match);
      pdf.text(chords, 10, y);
      y += 6;
    }

    let lyric = line.replace(/\[[^\]]+\]/g, "");
    pdf.text(lyric, 10, y);
    y += 8;

    if (y > 270) {
      pdf.addPage();
      y = 20;
    }
  }

  pdf.save((document.getElementById("title").textContent || "Canzone") + ".pdf");
}


// =======================================
// START
// =======================================
loadSong();
</script>

</body>
</html>

